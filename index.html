<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM2.5 Widget</title>
  <style>
    /* ใช้ CSS เดิมของคุณ */
  </style>
</head>
<body>
  <div class="container">
    <div class="header-group">
      <h3>รายงานสถานการณ์คุณภาพอากาศ</h3>
      <h4>โรงพยาบาลสมเด็จพระเจ้าตากสินมหาราช จ.ตาก</h4>
      <p id="current-datetime">อัพเดตล่าสุด: กำลังโหลด...</p>
    </div>
    <br><br>
    <div id="pm-widget" style="background-color: rgb(253, 192, 78);">
      <div id="aqi-image-container">
        <img id="aqi-image" src="./aqi_icon/ic-face-orange.svg" alt="Unhealthy for sensitive groups">
      </div>
      <div class="pm-title" id="pm-title">กำลังโหลด...</div>
      <div class="pm-value0" id="pm-25">-</div>
      <div class="small-text">ค่า PM2.5 ไม่ควรเกิน 37.5 มคก./ลบม.</div>
      <div class="pm-text" id="pm-text">กำลังโหลด...</div>
      <div id="pm-aqi-container">
        <div class="pm-value" id="pm-aqi">-</div>
        <div class="small-text">ค่า AQI</div>
      </div>
    </div>
  </div>

  <script>
    // ฟังก์ชันคำนวณ AQI
    function calculateAQI(Ci) {
      let Cmax, Cmin, Imax, Imin;
      if (Ci >= 0 && Ci <= 15) {
        Cmin = 0; Cmax = 15; Imax = 25; Imin = 0;
      } else if (Ci > 15 && Ci <= 25) {
        Cmin = 15.1; Cmax = 25; Imax = 50; Imin = 26;
      } else if (Ci > 25 && Ci <= 37.5) {
        Cmin = 25.1; Cmax = 37.5; Imax = 100; Imin = 51;
      } else if (Ci > 37.5 && Ci <= 75) {
        Cmin = 37.6; Cmax = 75; Imax = 200; Imin = 101;
      } else if (Ci > 75) {
        Cmin = 75.1; Cmax = 500; Imax = 500; Imin = 201;
      } else {
        throw new Error("Invalid PM2.5 concentration value");
      }
      const AQI = ((Imax - Imin) / (Cmax - Cmin)) * (Ci - Cmin) + Imin;
      return Math.round(AQI);
    }

    // ฟังก์ชันอัปเดตวันเวลา
    function updateDateTime() {
      const now = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
      document.getElementById('current-datetime').textContent = `อัพเดตล่าสุด: ${now.toLocaleDateString('th-TH', options)}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // ดึงข้อมูลจาก API
    const aqiUrl = 'https://www.cmuccdc.org/api/ccdc/value/5030';
    const apiKey = 'AmvZNJ1jyK4K6FO06VbhW0dTpkIfYk8NOOsdPcBp';

    fetch(aqiUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${apiKey}`, // ส่ง API Key ใน Header
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // ดึงข้อมูลจาก JSON
      const pm25 = data.pm25;
      const thTitle = data.th_title;
      const thCaption = data.th_caption;
      const logDatetime = data.log_datetime;
      const thColor = data.th_color;

      // คำนวณ AQI
      const aqi = calculateAQI(pm25);

      // อัปเดตข้อมูลในหน้าเว็บ
      document.getElementById("pm-aqi").textContent = `${aqi}`;
      document.getElementById("pm-25").textContent = `${pm25}`;
      document.getElementById("pm-title").textContent = `${thTitle}`;
      document.getElementById("pm-text").textContent = `${thCaption}`;
      document.getElementById("current-datetime").textContent = `อัพเดตล่าสุด: ${logDatetime}`;
      document.getElementById("pm-widget").style.backgroundColor = `rgb(${thColor})`;

      // อัปเดตรูปภาพตามระดับ AQI
      const aqiImageElement = document.getElementById('aqi-image');
      if (aqi <= 50) {
        aqiImageElement.src = './aqi_icon/ic-face-green.svg';
        aqiImageElement.alt = 'Good';
      } else if (aqi <= 100) {
        aqiImageElement.src = './aqi_icon/ic-face-yellow.svg';
        aqiImageElement.alt = 'Moderate';
      } else if (aqi <= 200) {
        aqiImageElement.src = './aqi_icon/ic-face-orange.svg';
        aqiImageElement.alt = 'Unhealthy';
      } else {
        aqiImageElement.src = './aqi_icon/ic-face-red.svg';
        aqiImageElement.alt = 'Very Unhealthy';
      }
    })
    .catch(error => console.error(error));
  </script>
</body>
</html>
